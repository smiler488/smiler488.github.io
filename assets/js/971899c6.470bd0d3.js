"use strict";(self.webpackChunkliangchao_website=self.webpackChunkliangchao_website||[]).push([[7137],{5227:(e,t,n)=>{n.r(t),n.d(t,{default:()=>h});var o=n(6540),r=n(3018),s=n(4848);const i=1800,a=60,l=10,c={bgThreshold:35,noiseKernel:3,blurRadius:24,roiThreshold:32},d={info:"root-status--info",success:"root-status--success",warning:"root-status--warning",danger:"root-status--danger"};function h(){const e="undefined"!=typeof window,[t,n]=(0,o.useState)([]),[h,b]=(0,o.useState)(0),[w,v]=(0,o.useState)("polygon"),[j,P]=(0,o.useState)("draw"),[N,C]=(0,o.useState)(14),[k,R]=(0,o.useState)(c),[I,D]=(0,o.useState)(!1),[S,_]=(0,o.useState)({text:"Upload JPG/PNG scans of root systems to begin.",tone:"info"}),E=(0,o.useRef)(null),O=(0,o.useRef)(null),L=(0,o.useRef)(null),T=(0,o.useRef)({}),U=(0,o.useRef)({}),M=(0,o.useRef)({}),B=(0,o.useRef)({}),A=(0,o.useRef)(!1),V=(0,o.useRef)(null),$=t[h]||null,z=(e,t="info")=>_({text:e,tone:t}),F=(0,o.useCallback)(((e,t)=>{n((n=>n.map((n=>{if(n.id!==e)return n;const o="function"==typeof t?t(n):t;return{...n,...o}}))))}),[]),K=(e,t)=>{R((n=>({...n,[e]:t})))},G=(0,o.useCallback)((()=>{if(!$)return;const e=O.current;if(!e)return;const t=e.getContext("2d").getImageData(0,0,e.width,e.height);U.current[$.id]=t;const n=B.current[$.id]||[];n.push(p(t)),n.length>l&&n.shift(),B.current[$.id]=n,F($.id,{processedVersion:Date.now(),historySize:n.length})}),[$,F]),W=(0,o.useCallback)((e=>{if(!$||"manual"!==w)return;if(!U.current[$.id])return z("Run auto-processing before manual editing.","warning"),void(A.current=!1);const t=O.current;if(!t)return;const n=t.getContext("2d");n.lineCap="round",n.lineJoin="round",n.strokeStyle="draw"===j?"#000000":"#ffffff",n.lineWidth=N;const o=f(e,t);if(Number.isFinite(o.x)&&Number.isFinite(o.y))if(A.current){n.beginPath();const e=V.current||o;n.moveTo(e.x,e.y),n.lineTo(o.x,o.y),n.stroke(),V.current=o}else A.current=!0,V.current=o,n.beginPath(),n.moveTo(o.x,o.y),n.lineTo(o.x+.1,o.y+.1),n.stroke()}),[$,w,j,N,z]);return(0,o.useEffect)((()=>{if(!e)return;const t=O.current;if(!t)return;const n=e=>{"manual"===w&&W(e)},o=e=>{"manual"===w&&A.current&&(e.preventDefault(),W(e))},r=()=>{A.current&&(A.current=!1,V.current=null,G())};return t.addEventListener("pointerdown",n),t.addEventListener("pointermove",o),window.addEventListener("pointerup",r),t.addEventListener("pointerleave",r),()=>{t.removeEventListener("pointerdown",n),t.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),t.removeEventListener("pointerleave",r)}}),[w,W,G,e]),(0,o.useEffect)((()=>{if(!$)return u(E.current),void u(O.current);const e=T.current[$.id];e&&g(E.current,e)}),[$]),(0,o.useEffect)((()=>{if(!$)return void u(O.current);const e=U.current[$.id];if(e&&"manual"===w)return void g(O.current,e);const t=M.current[$.id];if(t)return void g(O.current,t,$.polygonPoints,$.isPolygonClosed);const n=T.current[$.id];n&&g(O.current,n,$.polygonPoints,$.isPolygonClosed)}),[$,$?.previewVersion,$?.processedVersion,$?.polygonPoints,$?.isPolygonClosed,w]),e?(0,s.jsx)(r.A,{title:"Root Image Preprocessor",children:(0,s.jsxs)("div",{className:"root-app",children:[(0,s.jsxs)("div",{className:"root-app__header",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{children:"Root Image Preprocessor"}),(0,s.jsx)("p",{children:"Combine automated background removal with ROI high-pass filtering and manual cleanup directly in the browser. Inspired by 0_tranbg.py + 1_process.py."})]}),(0,s.jsx)("button",{type:"button",className:"root-button secondary",onClick:()=>L.current?.click(),children:"Upload Images"})]}),(0,s.jsx)("div",{className:`root-status ${d[S.tone]||""}`,children:S.text}),(0,s.jsxs)("div",{className:"root-app__grid",children:[(0,s.jsxs)("aside",{className:"root-sidebar",children:[(0,s.jsxs)("div",{className:"root-upload",children:[(0,s.jsx)("input",{type:"file",accept:"image/*",multiple:!0,ref:L,onChange:async o=>{if(!e)return;const r=Array.from(o.target.files||[]);if(!r.length)return;const s=t.length;z(`Loading ${r.length} image(s)...`,"info");const i=[];for(const e of r)try{const{imageData:t,width:n,height:o}=await m(e),r=`${e.name}-${Date.now()}-${Math.random().toString(16).slice(2)}`;T.current[r]=t,M.current[r]=p(t),i.push({id:r,name:e.name,width:n,height:o,polygonPoints:[],isPolygonClosed:!1,processedVersion:0,previewVersion:0,historySize:0})}catch(a){console.error(a),z(`Unable to read ${e.name}`,"warning")}i.length&&(n((e=>[...e,...i])),b(0===s?0:s),z("Images loaded. Select ROI points on the right canvas.","success")),o.target.value=""}}),(0,s.jsxs)("p",{children:["Drag & drop or pick files. Images larger than ",i,"px on the longest edge are scaled."]})]}),(0,s.jsxs)("div",{className:"root-filelist",children:[(0,s.jsxs)("div",{className:"root-filelist__header",children:[(0,s.jsx)("h3",{children:"Batch"}),(0,s.jsxs)("span",{children:[t.length," file(s)"]})]}),0===t.length&&(0,s.jsx)("p",{className:"root-muted",children:"No uploads yet."}),t.map(((e,t)=>(0,s.jsxs)("button",{className:"root-file "+(t===h?"root-file--active":""),onClick:()=>(e=>{b(e),v("polygon"),z("Polygon mode active. Click along the root area to define ROI.","info")})(t),children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:e.name}),(0,s.jsxs)("div",{className:"root-file__meta",children:[e.width," \xd7 ",e.height,"px"]})]}),(0,s.jsx)("div",{className:"root-file__status",children:U.current[e.id]?"Processed":"Pending"})]},e.id)))]}),(0,s.jsxs)("div",{className:"root-settings",children:[(0,s.jsx)("h3",{children:"Automation Settings"}),(0,s.jsxs)("label",{children:["Background threshold (",k.bgThreshold,")",(0,s.jsx)("input",{type:"range",min:"5",max:"120",value:k.bgThreshold,onChange:e=>K("bgThreshold",Number(e.target.value))})]}),(0,s.jsxs)("label",{children:["Noise kernel (",k.noiseKernel,")",(0,s.jsx)("input",{type:"range",min:"1",max:"9",step:"2",value:k.noiseKernel,onChange:e=>K("noiseKernel",Number(e.target.value)||1)})]}),(0,s.jsxs)("label",{children:["Blur radius (",k.blurRadius,"px)",(0,s.jsx)("input",{type:"range",min:"5",max:"50",value:k.blurRadius,onChange:e=>K("blurRadius",Number(e.target.value))})]}),(0,s.jsxs)("label",{children:["ROI threshold (",k.roiThreshold,")",(0,s.jsx)("input",{type:"range",min:"10",max:"80",value:k.roiThreshold,onChange:e=>K("roiThreshold",Number(e.target.value))})]}),(0,s.jsx)("button",{type:"button",className:"root-button ghost",onClick:async()=>{if(!$)return;const e=T.current[$.id];if(!e)return;z("Running fast background cleanup preview...","info"),await Promise.resolve();const t=x(e,k.bgThreshold,k.noiseKernel);M.current[$.id]=t,F($.id,{previewVersion:Date.now()}),z("Background preview updated.","success")},disabled:!$,children:"Preview Background Cleanup"})]})]}),(0,s.jsxs)("section",{className:"root-main",children:[(0,s.jsxs)("div",{className:"root-canvas-row",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"root-panel-heading",children:[(0,s.jsx)("h3",{children:"Original Preview"}),(0,s.jsx)("span",{className:"root-muted",children:"Read-only"})]}),(0,s.jsx)("canvas",{ref:E,className:"root-canvas"})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"root-panel-heading",children:[(0,s.jsx)("h3",{children:"ROI / Processing Canvas"}),(0,s.jsx)("span",{className:"root-muted",children:"polygon"===w?"Click to add polygon points":"Brush to refine"})]}),(0,s.jsx)("canvas",{ref:O,className:"root-canvas "+("manual"===w?"root-canvas--draw":"root-canvas--polygon"),onClick:e=>{if(!$||"polygon"!==w)return;if(U.current[$.id])return void z("Processed result detected. Reset to original to redefine ROI.","warning");const t=O.current;if(!t)return;const{x:n,y:o}=f(e,t);Number.isFinite(n)&&Number.isFinite(o)&&($.isPolygonClosed?z("Polygon already closed. Reset ROI to add more points.","warning"):$.polygonPoints.length>=a?z(`Point limit (${a}) reached. Close or reset the polygon.`,"warning"):F($.id,(e=>({polygonPoints:[...e.polygonPoints,{x:n,y:o}],isPolygonClosed:!1}))))}})]})]}),(0,s.jsxs)("div",{className:"root-controls",children:[(0,s.jsxs)("div",{className:"root-controls__group",children:[(0,s.jsx)("h4",{children:"ROI Polygon"}),(0,s.jsx)("p",{children:"Click on the right canvas to trace the region containing the root system."}),(0,s.jsxs)("div",{className:"root-chip-row",children:[(0,s.jsxs)("span",{className:"root-chip",children:["Points: ",$?.polygonPoints.length||0]}),(0,s.jsx)("span",{className:"root-chip",children:$?.isPolygonClosed?"Closed":"Open"})]}),(0,s.jsxs)("div",{className:"root-button-row",children:[(0,s.jsx)("button",{type:"button",className:"root-button",onClick:()=>{$&&($.polygonPoints.length<3?z("Need at least 3 points to close the polygon.","warning"):(F($.id,{isPolygonClosed:!0}),z("Polygon closed. You can still reset if needed.","success")))},disabled:!$,children:"Close Polygon"}),(0,s.jsx)("button",{type:"button",className:"root-button ghost",onClick:()=>{$&&$.polygonPoints.length&&F($.id,(e=>({polygonPoints:e.polygonPoints.slice(0,-1),isPolygonClosed:!1})))},disabled:!$,children:"Undo Point"}),(0,s.jsx)("button",{type:"button",className:"root-button ghost",onClick:()=>{$&&(F($.id,{polygonPoints:[],isPolygonClosed:!1}),z("ROI polygon reset.","info"))},disabled:!$,children:"Reset Polygon"})]})]}),(0,s.jsxs)("div",{className:"root-controls__group",children:[(0,s.jsx)("h4",{children:"Automation"}),(0,s.jsx)("p",{children:"Background removal (0_tranbg) and ROI enhancement (1_process) are combined. Use the sliders to tune the binary mask before running."}),(0,s.jsx)("button",{type:"button",className:"root-button primary",onClick:async()=>{if(!$)return void z("Upload an image first.","warning");if(!$.isPolygonClosed)return void z("Close the ROI polygon before processing.","warning");const e=T.current[$.id];if(e){D(!0),z("Processing ROI ... this may take a few seconds.","info"),await Promise.resolve();try{const t=function(e,t,n){const o=document.createElement("canvas");o.width=e,o.height=t;const r=o.getContext("2d");r.fillStyle="#ffffff",r.beginPath(),r.moveTo(n[0].x,n[0].y),n.forEach((e=>r.lineTo(e.x,e.y))),r.closePath(),r.fill();const s=r.getImageData(0,0,e,t).data,i=new Uint8Array(e*t);for(let a=0;a<i.length;a+=1)i[a]=s[4*a];return i}(e.width,e.height,$.polygonPoints),n=x(e,k.bgThreshold,k.noiseKernel);M.current[$.id]=n;const o=function(e,t,n,o){const r=function(e,t){if(t<=0)return p(e);const{width:n,height:o}=e,r=document.createElement("canvas");r.width=n,r.height=o,r.getContext("2d").putImageData(e,0,0);const s=document.createElement("canvas");s.width=n,s.height=o;const i=s.getContext("2d");return i.filter=`blur(${t}px)`,i.drawImage(r,0,0),i.getImageData(0,0,n,o)}(e,n),s=y(e),i=y(r),{width:a,height:l}=e,c=new Float32Array(s.length);let d=1/0,h=-1/0;for(let f=0;f<c.length;f+=1){const e=Math.max(0,i[f]-s[f]);c[f]=e,e<d&&(d=e),e>h&&(h=e)}const u=Math.max(1,h-d),g=new ImageData(a,l),m=g.data;for(let f=0;f<c.length;f+=1){const e=(c[f]-d)/u*255>o?255:0,n=t[f]?255-e:255,r=4*f;m[r]=n,m[r+1]=n,m[r+2]=n,m[r+3]=255}return g}(e,t,k.blurRadius,k.roiThreshold);U.current[$.id]=o,B.current[$.id]=[p(o)],F($.id,{processedVersion:Date.now(),previewVersion:Date.now(),historySize:1}),v("manual"),z("Processing complete. Switch to manual mode to clean up.","success")}catch(t){console.error(t),z("Processing failed. Try lowering the blur radius or image size.","danger")}finally{D(!1)}}else z("Original image data unavailable.","danger")},disabled:I||!$,children:I?"Processing...":"Run ROI Processing"})]}),(0,s.jsxs)("div",{className:"root-controls__group",children:[(0,s.jsx)("h4",{children:"Manual Cleanup"}),(0,s.jsx)("p",{children:"After automation, switch to manual mode to adjust fine details with brush + undo."}),(0,s.jsxs)("div",{className:"root-button-row",children:[(0,s.jsx)("button",{type:"button",className:"root-button "+("polygon"===w?"primary":"ghost"),onClick:()=>v("polygon"),disabled:!$,children:"Polygon Mode"}),(0,s.jsx)("button",{type:"button",className:"root-button "+("manual"===w?"primary":"ghost"),onClick:()=>{$&&(U.current[$.id]?v("manual"):z("Process the ROI before switching to manual mode.","warning"))},children:"Manual Brush"})]}),(0,s.jsxs)("div",{className:"root-manual-controls",children:[(0,s.jsxs)("label",{children:["Brush mode",(0,s.jsxs)("select",{value:j,onChange:e=>P(e.target.value),children:[(0,s.jsx)("option",{value:"draw",children:"Draw (black)"}),(0,s.jsx)("option",{value:"erase",children:"Erase (white)"})]})]}),(0,s.jsxs)("label",{children:["Brush size (",N,"px)",(0,s.jsx)("input",{type:"range",min:"4",max:"60",value:N,onChange:e=>C(Number(e.target.value))})]}),(0,s.jsx)("button",{type:"button",className:"root-button ghost",onClick:()=>{if(!$)return;const e=B.current[$.id];if(!e||e.length<2)return void z("Nothing to undo.","warning");e.pop();const t=e[e.length-1];U.current[$.id]=p(t),g(O.current,t),F($.id,{processedVersion:Date.now(),historySize:e.length})},disabled:!$||!U.current[$?.id],children:"Undo Brush Stroke"})]})]}),(0,s.jsxs)("div",{className:"root-controls__group",children:[(0,s.jsx)("h4",{children:"Export"}),(0,s.jsxs)("div",{className:"root-button-row",children:[(0,s.jsx)("button",{type:"button",className:"root-button secondary",onClick:()=>{if(!$)return;const e=U.current[$.id];e?(!function(e,t){const n=document.createElement("canvas");n.width=e.width,n.height=e.height;if(n.getContext("2d").putImageData(e,0,0),n.toBlob)return void n.toBlob((e=>{if(!e)return;const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,o.click(),URL.revokeObjectURL(n)}),"image/png");const o=n.toDataURL("image/png"),r=document.createElement("a");r.href=o,r.download=t,r.click()}(e,`${function(e){const t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}($.name)}-processed.png`),z("Download triggered.","success")):z("Run processing before downloading.","warning")},disabled:!$,children:"Download Processed PNG"}),(0,s.jsx)("button",{type:"button",className:"root-button ghost",onClick:()=>{$&&(delete U.current[$.id],delete B.current[$.id],F($.id,{processedVersion:Date.now(),historySize:0}),v("polygon"),z("Processed result cleared. You can redefine the ROI.","info"))},disabled:!$,children:"Reset Processed Result"})]})]})]})]})]})]})}):(0,s.jsx)(r.A,{title:"Root Image Preprocessor",children:(0,s.jsx)("div",{className:"root-app root-app--placeholder",children:(0,s.jsx)("p",{children:"Loading root preprocessing workspace..."})})})}function u(e){if(!e)return;const t=e.getContext("2d");e.width=640,e.height=360,t.fillStyle="#f5f5f7",t.fillRect(0,0,e.width,e.height),t.setLineDash([6,6]),t.strokeStyle="#d2d2d7",t.strokeRect(16,16,e.width-32,e.height-32),t.setLineDash([]),t.fillStyle="#a1a1a6",t.font="16px Inter, sans-serif",t.textAlign="center",t.fillText("Awaiting image...",e.width/2,e.height/2)}function g(e,t,n=[],o=!1){if(!e||!t)return;const r=e.getContext("2d");e.width=t.width,e.height=t.height,r.putImageData(t,0,0),n.length&&(r.save(),r.strokeStyle="#2188ff",r.fillStyle="rgba(33,136,255,0.12)",r.lineWidth=2,r.beginPath(),r.moveTo(n[0].x,n[0].y),n.forEach((e=>r.lineTo(e.x,e.y))),o&&(r.closePath(),r.fill()),r.stroke(),n.forEach((e=>{r.beginPath(),r.arc(e.x,e.y,4,0,2*Math.PI),r.fillStyle="#ffffff",r.fill(),r.strokeStyle="#2188ff",r.stroke()})),r.restore())}async function m(e){const t=await function(e){return new Promise(((t,n)=>{if("createImageBitmap"in window)return void createImageBitmap(e).then((e=>{t({element:e,width:e.width,height:e.height,revoke:()=>e.close()})})).catch((e=>n(e)));const o=new Image,r=URL.createObjectURL(e);o.onload=()=>{t({element:o,width:o.naturalWidth,height:o.naturalHeight,revoke:()=>URL.revokeObjectURL(r)})},o.onerror=e=>n(e),o.src=r}))}(e),n=Math.min(1,i/Math.max(t.width,t.height)),o=Math.max(1,Math.round(t.width*n)),r=Math.max(1,Math.round(t.height*n)),s=document.createElement("canvas");s.width=o,s.height=r;const a=s.getContext("2d");a.drawImage(t.element,0,0,o,r);const l=a.getImageData(0,0,o,r);return t.revoke&&t.revoke(),{imageData:l,width:o,height:r}}function f(e,t){const n=t.getBoundingClientRect(),o=t.width/n.width,r=t.height/n.height;return{x:Math.round((e.clientX-n.left)*o),y:Math.round((e.clientY-n.top)*r)}}function p(e){return new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}function x(e,t,n){const{width:o,height:r,data:s}=e,i=y(e),a=new Uint8Array(i.length);for(let h=0;h<i.length;h+=1)a[h]=i[h]>t?255:0;const l=n>1?function(e,t,n,o){const r=function(e,t,n,o){const r=Math.max(1,Math.floor(o/2)),s=new Uint8Array(e.length);for(let i=0;i<n;i+=1)for(let o=0;o<t;o+=1){let a=255;for(let s=-r;s<=r&&a;s+=1){const l=i+s;if(l<0||l>=n){a=0;break}for(let n=-r;n<=r;n+=1){const r=o+n;if(r<0||r>=t||!e[l*t+r]){a=0;break}}}s[i*t+o]=a}return s}(e,t,n,o);return function(e,t,n,o){const r=Math.max(1,Math.floor(o/2)),s=new Uint8Array(e.length);for(let i=0;i<n;i+=1)for(let o=0;o<t;o+=1){let a=0;for(let s=-r;s<=r&&!a;s+=1){const l=i+s;if(!(l<0||l>=n))for(let n=-r;n<=r;n+=1){const r=o+n;if(r>=0&&r<t&&e[l*t+r]){a=255;break}}}s[i*t+o]=a}return s}(r,t,n,o)}(a,o,r,n):a,c=new ImageData(o,r),d=c.data;for(let h=0;h<i.length;h+=1){const e=4*h;l[h]?(d[e]=s[e],d[e+1]=s[e+1],d[e+2]=s[e+2]):(d[e]=255,d[e+1]=255,d[e+2]=255),d[e+3]=255}return c}function y(e){const{data:t,width:n,height:o}=e,r=new Float32Array(n*o);for(let s=0;s<r.length;s+=1){const e=4*s;r[s]=.299*t[e]+.587*t[e+1]+.114*t[e+2]}return r}}}]);